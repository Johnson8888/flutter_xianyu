/* mix-view-adaptor (min) v0.3.8, build at 2020-05-13 12:12. */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e["mix-view-adaptor"]=t()}(this,function(){"use strict";"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{writable:!0,enumerable:!1,configurable:!0,value:function(e){var t=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(e),n=1;n<arguments.length;n++){var i=t[n];if(null!=i)for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(r[o]=i[o])}return r}});var t,u='object[type="application/view"]',c='div[type="application/view"][original-type="object"]',s="mixviewcallback",d="query",x="data-object-id",l="data-observed",v=(t=Date.now()%999999,function(e){return void 0===e&&(e="mix_view"),e+"_"+t++});function f(){return"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:new Function("return this")()}function n(){var e=f();return e&&e.__mix_view_environment__}function r(){return{r:(99999999*Math.random()|0)%256,g:(99999999*Math.random()|0)%256,b:(99999999*Math.random()|0)%256,a:.01}}function p(e){return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"}var i,h=(i={},function(){for(var e=r(),t=p(e);i[t];)t=p(e=r());return i[t]=e});function o(n,i){var o;return void 0===i&&(i=0),"function"!=typeof setTimeout||"function"!=typeof clearTimeout?n:function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];var r=this;clearTimeout(o),o=setTimeout(function(){return n.apply(r,e)},i)}}function a(){return"object"==typeof process&&process&&process.env&&"test"===process.env.PURPOSE}function m(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function b(e){return Object.prototype.toString.call(e).slice(8,-1)}function g(e){return"Object"===b(e)}function y(e){return"Function"===b(e)}function _(e){return e&&1===e.nodeType}function w(){var e=n();return e&&"color"===e.matchType}function A(e){var t=n();return!(!g(t.availableTypes)||!m(t.availableTypes,e))}function O(e){return"type"===e||"viewType"===e}function j(e){return w()?_(e)&&/^object$/i.test(e.nodeName)&&"application/view"===String(e.getAttribute("type")).toLowerCase()&&"object"===String(e.getAttribute("original-type")).toLowerCase():_(e)&&/^object$/i.test(e.nodeName)&&"application/view"===String(e.getAttribute("type")).toLowerCase()}function C(e){return _(e)&&/^param$/i.test(e.nodeName)}function T(e){return!1!==e&&0!==e&&!e||"undefined"==e||"null"==e||"NaN"==e}function e(){var e=n();return e&&"string"==typeof e.platform&&"android"===e.platform.toLowerCase()}function E(){var e=f(),t=n();return e&&void 0!==e.AFAppX||t&&"yes"===String(t.isForAppX).toLowerCase()}function L(){return E()?"1":"0"}var N=["all","debug","log","warn","error","silent"],S="warn",P=function(e,t){var r,n="["+((r=e).charAt(0).toUpperCase()+r.slice(1))+"][mix_view] "+t;if("function"==typeof console[e]&&"debug"!==e)return console[e](n);console.log(n)};function M(e){if(a())return"function"==typeof __test_logger__&&(P=__test_logger__,1);var t=n(),r=t&&t.logLevel||S;return N.indexOf(e)>=N.indexOf(r)}function q(e){M("debug")&&P("debug",e)}function k(e){M("warn")&&P("warn",e)}function F(e){M("error")&&P("error",e)}function D(){}D.prototype.postMessage=function(e){if(e&&e.length){var t=f();try{q("Post message: "+JSON.stringify(e)),t.webkit.messageHandlers.mixView.postMessage(e)}catch(e){F("Failed to postMessage: "+e.toString())}}},D.prototype.onmessage=function(t,r){void 0===r&&(r="mixviewevent"),f().addEventListener(r,function(e){q('Receive event "'+r+'": '+JSON.stringify(e.data)),e&&g(e.data)&&"function"==typeof t&&t(e.data)})};var I=function(e){function t(){e.call(this)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.postMessage=function(e){if(e&&e.length){var t=f();try{q("Post message (on Android): "+JSON.stringify(e)),t.mixView.postMessage(e)}catch(e){F("Failed to postMessage (on Android): "+e.toString())}}},t}(D),V="[[EVENT_MAP]]";function R(e,t){var r=e[V];return Array.isArray(r[t])||(r[t]=[]),r[t]}function $(){Object.defineProperty(this,V,{configurable:!1,enumerable:!1,writable:!1,value:{}})}$.prototype.on=function(e,t){return R(this,e).push({listener:t,once:!1,callCount:0}),this},$.prototype.once=function(e,t){return R(this,e).push({listener:t,once:!0,callCount:0}),this},$.prototype.off=function(e,t){var r,n,i=this[V];return t?(r=i[e],!Array.isArray(r)||-1!==(n=r.findIndex(function(e){return e.listener===t}))&&r.splice(n,1)):delete i[e],this},$.prototype.emit=function(t){for(var r=[],e=arguments.length-1;0<e--;)r[e]=arguments[e+1];var n=this[V],i=n[t];return Array.isArray(i)&&(n[t]=i.filter(function(e){try{e.listener.apply(null,r),e.callCount+=1}catch(e){return F('Failed to emit "'+t+'" event.\n'+e.toString()),!0}return!e.once})),this};var J=new(e()?I:D),U=new $;function H(e,t,r){return t+"_"+r+"@"+e}function z(o,a){o[a]=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return q('Call the "'+a+'" method on '+o.tagName+"#"+o.id),new Promise(function(r,n){var i=v();U.once(H(o.id,a,i),function(e){var t;q('Receive callback of "'+a+'" on '+o.tagName+"#"+o.id+" (id: "+i+")."),g(e)?(!function(e){if(g(e)&&m(e,"success")){if("string"==typeof e.success)switch(e.success.toLowerCase()){case"true":case"1":return 1;case"false":case"0":return}return e.success}}(e)?n:r)(e.data):(F(t='Invalid message format of the "'+a+'" callback!'),n(new Error(t)))}),J.postMessage([{id:o.id,action:"callMethod",name:a,args:e,callbackId:i}]),J.onmessage(function(e){var t=e.id,r=e.name,n=e.callbackId;U.emit(H(t,r,n),e)},s)})};try{Object.defineProperty(o[a],a,{value:a})}catch(e){}}function X(t,e){_(t)&&"Array"===b(e)&&(q('Register native methods on "'+t.tagName+"#"+t.id+'" ('+e.join(", ")+")."),e.forEach(function(e){z(t,e)}))}var Q=["border-top-left-radius","border-top-right-radius","border-bottom-left-radius","border-bottom-right-radius","border-radius"],W=["style","class",l,x];function B(e){var t={};if(e.hasAttributes())for(var r=0;r<e.attributes.length;++r){var n=e.attributes[r];-1===W.indexOf(n.name)&&(t[n.name]=n.value)}return t}function G(e,t){void 0===t&&(t={}),q("Start parse the <"+e.tagName+' id="'+e.id+'"> element');var r="",n={};if(e.children)for(var i=0;i<e.children.length;++i){var o,a=e.children[i];C(a)&&(O(o=a.getAttribute("name"))?A(r=a.getAttribute("value"))||F('The "'+r+'" view type is not supported!'):n[o]=B(a),q('Set "'+x+'" of <'+a.tagName+' name="'+o+'"> to be "'+e.id+'".'),a.setAttribute(x,e.id))}var s=[];for(var u in e){var c=/^on([a-z]+)$/.exec(u);c&&c[1]&&y(e[u])&&s.push(c[1])}var d={type:r,viewType:r,styles:function(e){var t=f();if(t&&"function"==typeof t.getComputedStyle){var r=t.getComputedStyle(e),n={};return Q.forEach(function(e){n[e]=r.getPropertyValue(e)}),n}return{}}(e),backgroundColor:t.backgroundColor};return Object.keys(n).length&&(d.params=n),s.length&&(d.events=s),d}function K(n,i){var o=n,a=[];o._events=Object.create(null);function e(e){var t,r=/^on([a-z]+)$/.exec(e);r&&r[1]&&(t=r[1],o._events[t]=n[e],Object.defineProperty(n,e,{enumerable:!0,configurable:!0,get:function(){return o._events[t]},set:function(e){y(i)&&i(t,e,o._events[t]),o._events[t]=e}}),y(n[e])&&a.push(t))}for(var t in n)e(t);return a}function Y(e,n,i){m(e,"addEventListener")||(e._addEventListener=e.addEventListener,Object.defineProperty(e,"addEventListener",{writable:!0,enumerable:!0,configurable:!0,value:function(e,t,r){y(n)&&n(e,this),this._addEventListener(e,t,r)}})),m(e,"removeEventListener")||(e._removeEventListener=e.removeEventListener,Object.defineProperty(e,"removeEventListener",{writable:!0,enumerable:!0,configurable:!0,value:function(e,t,r){y(i)&&i(e,this),this._removeEventListener(e,t,r)}}))}var Z=["title","style","class",l,x];function ee(t){return new MutationObserver(function(e){var N=[];e.forEach(function(e){var t,r,n,i,o,a,s,u=e.type,c=e.attributeName,d=e.oldValue,l=e.target;if(1===l.nodeType)switch(u){case"attributes":var v,f,p,h,m=l.getAttribute(c);s=c,!j(a=l)&&!C(a)||-1!==Z.indexOf(s)||((i=d)==(o=m)||T(i)&&T(o))||(q('Captured "'+c+'" attribute change of <'+l.nodeName+'> (old: "'+d+'", new: "'+m+'").'),j(l)?(v={id:l.id,appx:L(),action:"setAttributes",args:[((t={})[c]=m,t)]},N.push(v)):C(l)&&(f=l.getAttribute(x),p=l.getAttribute("name"),h=B(l),q('The "'+p+'" param of #'+f+" object is changed to "+JSON.stringify(h)+"."),N.push({id:f,action:"setParams",args:[((r={})[p]=h,r)]})));break;case"childList":if(!j(l))break;var b=e.addedNodes,g=e.removedNodes;if(q("Captured params change of <"+l.nodeName+"> (added: "+b.length+", removed: "+g.length+")."),b.length)for(var y,_,w=0;w<b.length;++w){C(b[w])&&(_=(y=b[w]).getAttribute("name"),y.setAttribute(x,l.id),q("Captured newly inserted <"+y.nodeName+' name="'+_+'"> and set its "'+x+'" to be "'+l.id+'".'),N.push({id:l.id,action:"setParams",args:[((n={})[_]=B(y),n)]}))}if(g.length)for(var A,O,E=0;E<g.length;++E){C(g[E])&&(O=(A=g[E]).getAttribute("name"),q("Captured the <"+A.nodeName+' name="'+O+'"> has been deleted.'),N.push({id:A.getAttribute(x),action:"removeParams",args:[O]}))}}}),t(N)})}function te(e,t){if(void 0===t&&(t="div"),!e.parentNode)return k("The <"+e.tagName+"> element is offline, can't replace its tagName."),e;if(e.tagName.toLowerCase()===t.toLowerCase())return e;for(var r=document.createElement(t),n=0,i=e.attributes.length;n<i;++n){var o=e.attributes.item(n).nodeName,a=e.attributes.item(n).nodeValue;r.setAttribute(o,a)}for(;e.firstChild;)r.appendChild(e.firstChild);return e.parentNode.replaceChild(r,e),r}function re(e){for(var t=[],r=0;r<e.length;++r){var n=e[r];if("function"==typeof n.matches&&(n.matches(u)||n.matches(c))&&-1===t.indexOf(n)&&t.push(n),"function"==typeof n.querySelectorAll){for(var i=n.querySelectorAll(u),o=0;o<i.length;++o)-1===t.indexOf(i[o])&&t.push(i[o]);for(var a=n.querySelectorAll(c),s=0;s<a.length;++s)-1===t.indexOf(a[s])&&t.push(a[s])}}return t}function ne(){return!E()}function ie(){this._label=v("manager"),this._views=Object.create(null),this._messages=Object.create(null),this._observers=Object.create(null),e()?this._bridge=new I:this._bridge=new D,this._setup()}function oe(){var t=new ie;q("Setup MixView Manager "+t.label()),function(t,r,e){void 0===e&&(e=!0);var n=f();try{Object.defineProperty(n,t,{value:r,configurable:!0,enumerable:!0,writable:!e})}catch(e){n[t]=r}}("__mix_view_manager__",t),document.addEventListener("DOMContentLoaded",function(){t.observeDocument(),t.queryAndObserve()}),setTimeout(function(){t.observeDocument(),t.queryAndObserve();var e=setInterval(function(){t.queryAndObserve()},3e3);setTimeout(function(){return clearInterval(e)},1e4)},0)}return ie.prototype._isObserved=function(e){return!(!e||e.getAttribute(l)!=this._label)},ie.prototype._setup=function(){var s=this;this.send=o(function(){return s._sendMessages()},30);function u(){q("Start query and observe mix views. (observing: "+Object.keys(s._views).join(", ")+")"),s.query(),s.observe(),s.send()}ne()?(q("Add 10ms debounce for queryAndObserve."),this.queryAndObserve=o(u,10)):(q("No debounce for queryAndObserve."),this.queryAndObserve=u),this._bridge.onmessage(function(e){var t,r,n,i=e.id,o=e.name,a=e.data;o!=d?s._views[i]&&(q('Dispatch "'+o+'" event on "#'+i+'".'),t=s._views[i].element,(r=new CustomEvent(o,{detail:a})).data=a,t.dispatchEvent(r)):(q('Query element of "'+i+'" ('+d+")"),u(),(n=s._views[i])&&n.options?(q('Found listening element of "'+i+'" (type: '+n.options.viewType+")"),s.schedule([{id:i,appx:L(),action:"queryElement",args:[n.options]}]),s._sendMessages()):k("Can't find element of \""+i+'".'))});function e(e,t){j(t)&&(s.schedule([{id:t.id,appx:L(),action:"addEvent",args:[e]}]),s.send())}function t(e,t){j(t)&&(s.schedule([{id:t.id,appx:L(),action:"removeEvent",args:[e]}]),s.send())}Y(HTMLObjectElement.prototype,e,t),w()&&Y(HTMLDivElement.prototype,e,t)},ie.prototype._parseInlineEvent=function(e){var n=this,i=e.id,t=K(e,function(e,t,r){y(t)&&!y(r)?n.schedule([{id:i,appx:L(),action:"addEvent",args:[e]}]):!y(t)&&y(r)&&n.schedule([{id:i,appx:L(),action:"removeEvent",args:[e]}]),n.send()});t.length&&(this.schedule([{id:i,appx:L(),action:"addEvent",args:t}]),this.send())},ie.prototype._registerMethods=function(e,t){var r=n();r&&g(r.availableTypes)&&X(e,r.availableTypes[t])},ie.prototype._sendMessages=function(){var e=[];for(var t in this._messages){var r=this._messages[t];for(var n in r){var i={id:t,appx:L(),action:n};m(r,n)&&r[n]&&(i.args=r[n]),e.push(i),delete r[n]}delete this._messages[t]}e.length&&this._bridge.postMessage(e)},ie.prototype.label=function(){return this._label},ie.prototype.shouldDowngrade=function(e){return!n()||!(!_(e)||A(function(e){if(j(e)&&e.children.length)for(var t=0;t<e.children.length;++t){var r=e.children[t];if(C(r)&&O(r.getAttribute("name")))return r.getAttribute("value")}return C(e)&&O(e.getAttribute("name"))?e.getAttribute("value"):""}(e)))&&(e.dispatchEvent(new Event("error")),!0)},ie.prototype.query=function(){var t=this,e=function(e){void 0===e&&(e=function(){return!0});for(var t={},r=re([document]),n=0;n<r.length;++n){var i,o,a,s=r[n];1===s.nodeType&&e(s)&&(q("Found the <"+s.nodeName+"> element (#"+s.id+") and start to preprocess it."),i=s.tagName.toLowerCase(),w()&&"div"!==i&&(k("The <"+i+"> element is not supported in current environment, it will be replaced by a <div> element."),(s=te(s,"div")).setAttribute("original-type",i)),o=v(),s.id?t[s.id]&&(k('The id "'+s.id+'" of <'+s.nodeName+'> has already been used, it will be replaced by "'+o+'".'),s.id=o,s.setAttribute("id",o)):(s.id=o,s.setAttribute("id",o)),a=h(),s.style["-webkit-transform"]="translate3d(0,0,0)",s.style["background-color"]=p(a),t[s.id]={options:G(s,{backgroundColor:a}),element:s})}return t}(function(e){return e&&!t._views[e.id]});for(var r in e)this._views[r]||(this._views[r]=e[r]);return this},ie.prototype.observe=function(){var t=this;for(var e in this._views){var r,n=this._views[e],i=n.options,o=n.element;this._observers[e]||(q("Start to observe the <"+o.tagName+"> element (#"+o.id+")."),this._parseInlineEvent(o),this._registerMethods(o,i.viewType||i.type),(r=ee(function(e){t.schedule(e),t.send()})).observe(o,{attributes:!0,attributeOldValue:!0,childList:!0,subtree:!0}),this._observers[e]=r,o.setAttribute(l,this._label),this.schedule([{id:e,appx:L(),action:"createElement",args:[i]}]))}return this},ie.prototype.schedule=function(e){var c=this;return e.forEach(function(e){var t=e.id,r=e.action,n=e.args;m(c._messages,t)||(c._messages[t]=Object.create(null));var i=c._messages[t];if(m(i,r)&&n?(-1!==["setParams","setAttributes","setStyles"].indexOf(r)&&n.forEach(function(e,t){i[r][t]?Object.assign(i[r][t],e):i[r][t]=e}),-1!==["removeParams","removeAttributes","removeStyles","addEvent","removeEvent"].indexOf(r)&&n.forEach(function(e){-1===i[r].indexOf(e)&&i[r].push(e)})):i[r]=n,m(i,"createElement")&&m(i,"removeElement")&&(delete i.createElement,delete i.removeElement),m(i,"createElement")&&i.createElement[0]){var o,a=i.createElement[0];if(m(i,"addEvent")&&(o=i.addEvent,Array.isArray(o)&&(a.events&&Array.isArray(a.events)?o.forEach(function(e){-1===a.events.indexOf(e)&&a.events.push(e)}):a.events=o),delete i.addEvent),m(i,"removeEvent")&&a.events){for(var s=0;s<i.removeEvent.length;++s){var u=a.events.indexOf(i.removeEvent[s]);-1!==u&&a.events.splice(u,1)}delete i.removeEvent}m(i,"setParams")&&(i.setParams.forEach(function(e){a.params=Object.assign({},a.params,e)}),delete i.setParams),m(i,"removeParams")&&a.params&&(i.removeParams.forEach(function(e){delete a.params[e]}),delete i.removeParams)}}),this},ie.prototype.observeDocument=function(e){var t,r,s=this;if(void 0===e&&(e=document.body),e)return this._isObserved(e)?this.cleanUp(e):(t=function(e){e.forEach(function(e){var t=e.type,r=e.target,n=e.addedNodes,i=e.removedNodes;if("childList"===t&&1===r.nodeType){q("Captured element tree change of <"+r.nodeName+"> (added: "+n.length+", removed: "+i.length+").");var o=re(i);if(o.length)for(var a=0;a<o.length;++a)s.stopObserve(o[a]);(n.length||o.length)&&s.queryAndObserve()}})},r=ne()?new MutationObserver(o(t,5)):new MutationObserver(t),q("Start observe the root element <"+e.tagName+">."),r.observe(e,{childList:!0,subtree:!0}),e.setAttribute(l,this._label)),this;k('No available "document.body", will try again!')},ie.prototype.stopObserve=function(e){var t;return j(e)&&this._isObserved(e)&&(t=e.id,q("Stop observe <"+e.tagName+"> (#"+t+")."),delete this._views[t],delete this._messages[t],this._observers[t]&&(this._observers[t].disconnect(),delete this._observers[t]),e.removeAttribute(l),this.schedule([{id:t,appx:L(),action:"removeElement"}])),this},ie.prototype.cleanUp=function(e){if(void 0===e&&(e=document.body),q("Will clean up observed elements."),e&&!this._isObserved(e)){e.removeAttribute(l);for(var t=re([e]),r=0;r<t.length;++r)if(1===t[r].nodeType){var n=t[r],i=n.id;q("Remove observe flags on <"+n.tagName+"> (#"+i+")."),delete this._views[i],delete this._messages[i],this._observers[i]&&(this._observers[i].disconnect(),delete this._observers[i]),n.removeAttribute("original-type"),n.removeAttribute(l);for(var o,a=n.querySelectorAll("param"),s=0;s<a.length;++s){1===a[s].nodeType&&(q("Remove observe flags on <"+(o=a[s]).tagName+"> (#"+o.id+")."),o.removeAttribute(x),o.removeAttribute(l))}}}},a()||oe(),oe});