/**
  * windmill.worker.min.js v0.5.4.
  */
console.log("Start windmill worker.min (0.5.4) framework. Build at 2019-02-28 14:18"),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e["windmill-worker"]=t()}(this,function(){"use strict";"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{writable:!0,enumerable:!1,configurable:!0,value:function(e,t){var n=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),r=1;r<arguments.length;r++){var a=n[r];if(null!=a)for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(i[o]=a[o])}return i}});var t="__windmill_environment__",u="__dispatch_message__",n="__dispatch_message_sync__",l="__receive_message__",p="__get_app_context__",g="__get_plugin_context__",f="__WINDMILL_WORKER_RUNTIME_APIS__",h="__WINDMILL_MODULE_GETTER__",d="[[PAGE_LIFECYCLES_EMITTED]]",i=function(){},v={},r=["debug","info","log","warn","error"];function a(e){if("object"==typeof process&&process&&process.env,!0===v.debugMode||"true"===v.debugMode)return!0;var t=v.logLevel||"error";return r.indexOf(e)>=r.indexOf(t)}function y(e){a("debug")&&i("debug",e)}function m(e){a("warn")&&i("warn",e)}function b(e){a("error")&&i("error",e)}function _(e){b(e)}i=function(e,t){var n,i="["+((n=e).charAt(0).toUpperCase()+n.slice(1))+"][wml-w] "+t;console.log(i)};var o,c,s=(o=1e5,function(){var e=String(o);return o+=1,e});function S(){return"undefined"!=typeof global?global:"undefined"!=typeof self?self:new Function("return this")()}function k(){if(!c){var e=S();e[t]?c=e[t]:b("Can't find available environment variable ("+t+") in the worker context.")}return c||{}}function w(t,n,e){void 0===e&&(e=!0);var i=S();try{Object.defineProperty(i,t,{value:n,configurable:!0,enumerable:!0,writable:!e})}catch(e){i[t]=n}}function E(e){return"Object"===(t=e,Object.prototype.toString.call(t).slice(8,-1));var t}function I(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t]}var A={network:["request","uploadFile","downloadFile"],miniApp:["setAppShareInfo","hideLauncherLoading","setWebViewTop","setWebViewBackgroundImage","getConfig","reLaunch"],mtop:["request"],storage:["length","setItem","getItem","removeItem","clearStorage","getStorageInfo",{name:"getItemSync",sync:!0},{name:"setItemSync",sync:!0},{name:"removeItemSync",sync:!0},{name:"clearStorageSync",sync:!0},{name:"getStorageInfoSync",sync:!0}],memoryStorage:["setItem","getItem"],tabBar:["show","hide","setTabBarItem","setTabBarStyle","setTabBarBadge","removeTabBarBadge","showTabBarRedDot","hideTabBarRedDot","addTabBarItem","removeTabBarItem"],eBizCapability:["favorShop","collectGoods","checkShopFavoredStatus","checkGoodsCollectedStatus"],navigator:["push","pop","openMessagePage","reloadPage","getBackStack","popToHome","navigateTo","redirectTo","switchTab","navigateBackMiniProgram","navigateToMiniProgram"],user:["login","logout","info"],hostApp:["getAuthUserInfo","getAuthCode"],modal:["alert","confirm","toast","hideToast","showLoading","hideLoading","prompt"],navigatorBar:["show","hide","setTitle","setRightItem","setStyle","setDrawer","setActionSheet","hasIndexBadge","scaleIndexBadge","resetIndexBadge","getHeight","openDrawer","isDrawerOpened","closeDrawer","setLeftItem","showMenu","hideMenu","getStatusBarHeight","setNavigationBar","hideNavigationBarLoading","showNavigationBarLoading"],clipboard:["writeText","readText"],picker:["pick","pickDate","pickTime","chooseCity"],webSocket:["webSocket","send","close","onOpen","onMessage","onClose","onError"],calendar:["addEvent","checkEvent","removeEvent"],connection:["getType","getDownlinkMax","onChange"],screen:["setAlwaysOn","setBrightness","getScreenBrightness"],broadcast:["createChannel","postMessage","onMessage","close"],share:["doShare"],cookie:["read","write","getAllObjects"],audio:["load","play","pause","stop","setVolume","canPlayType"],wopc:["getSessionKey","setSessionKey","authorize","getSetting","openSetting"],WopcMtopPlugin:["request"],device:["onShake","vibrate","vibrateShort","onUserCaptureScreen","offUserCaptureScreen","scan"],keyboard:["hideKeyboard"],contact:["choosePhoneContact"],location:["getLocation"],alipay:["tradePay"],userTrack:["commit","commitut","commitEvent","customAdvance","pageAppear","pageDisappear","skipPage","updatePageUtparam","updateNextPageUtparam"],"nuvajs-exec":["exec"],aluWVJSBridge:["userIsLogin","refreshAlipayCookie"],TBDeviceInfo:["getUtdid"],actionSheet:["showActionSheet"],image:["chooseImage","previewImage","compressImage","getImageInfo","saveImage"],media:["startVoice","stopVoice"],audioRecord:["startRecord","stopRecord","cancelRecord"],audioPlayer:["playVoice","pauseVoice","stopVoice"],file:["saveFile","getFileInfo","getFileList","removeFile"],video:["chooseVideo","getVideoInfo","saveVideoToPhotosAlbum"],phone:["makePhoneCall"],compass:["startCompass","stopCompass","onCompassChange"],tbsecurity:["secureToken"],sendMtop:["request"],ZCache:["prefetch","fetch"],WVZCache:["prefetch","fetch"],sku:["show","hide"],chat:["open"],ucc:["uccBind","uccTrustLogin","uccUnbind"],address:["choose"],private:["addProperties"],taopai:["openTaopaiShoot","openTaopaiEdit"],poi:["openPOI"]};function C(e){return"Event@Global."+e}function M(e,t){var n,i=k(),r=Object.freeze(JSON.parse(JSON.stringify(i))),a=Object.assign({__windmill_environment__:r},(n=e.getEmitter(),{addEventListener:function(e,t){y("Call addEventListener in app context: "+e),"function"==typeof t?n.on(C(e),t):b("invalid callback argument for addEventListener: "+t)},removeEventListener:function(e,t){y("Call removeEventListener in app context: "+e),t&&"function"!=typeof t?b("invalid callback argument for addEventListener: "+t):n.off(C(e),t)}}),t.getContext());return y("Get app running context ("+t.name+"). "+Object.keys(a)),e.$call("AppWorker.contextReady",{type:t.name,version:"0.5.4",apis:Object.keys(a)}),a}var e=function(){};e.prototype.$on=function(e,t){return void 0===t&&(t=I),y('$on "'+e+'"'),!e&&_("invalid event name "+e+" for windmill.$on."),t===I&&_("bind event "+e+" with no callback through windmill.$on."),this.bridge.onReceiveMessage({data:{type:e},origin:this.label,type:"Event"},t)},e.prototype.$once=function(e,t){return void 0===t&&(t=I),y('$once "'+e+'"'),!e&&_("invalid event name "+e+" for windmill.$once."),t===I&&_("bind event "+e+" with no callback through windmill.$once."),this.bridge.onReceiveMessage({data:{type:e,once:!0},origin:this.label,type:"Event"},t)},e.prototype.$off=function(e,t){return y('$off "'+e+'"'),!e&&_("invalid event name "+e+" for windmill.$off."),this.bridge.unbindEventListener("Event."+e,t)},e.prototype.$cycle=function(e,t){return void 0===t&&(t=I),y('$cycle "'+e+'"'),e&&/^app:|^page(:|@)/.test(e)||_("invalid lifecycle name "+e+" for windmill.$cycle."),t===I&&_("hook lifecycle "+e+" with no callback function through windmill.$cycle."),"AppWorker"!==this.label&&/^app:/.test(e)&&_("Shouldn't bind lifecycle hook for app in a page client."),this.bridge.onReceiveMessage({type:"Lifecycle",origin:this.label,data:{type:e}},t)},e.prototype.$decycle=function(e,t){return y('$decycle "'+e+'"'),e&&/^app:|^page(:|@)/.test(e)||_("invalid lifecycle name "+e+" for windmill.$decycle."),this.bridge.unbindEventListener("Lifecycle."+e,t)},e.prototype.$emit=function(e,t,n){return void 0===t&&(t={}),y('$emit("'+e+'")'),!e&&_("invalid event name "+e+" for windmill.$emit."),n&&n!==this.label?this.bridge.postMessage({data:{type:e,data:t},origin:this.label,target:n,type:"Event"}):this.bridge.emitEvent(""+e,t)},e.prototype.$callAsync=function(n,i,r,a){var o=this;return void 0===i&&(i={}),void 0===r&&(r={}),void 0===a&&(a={}),y('$callAsync "'+n+'"'),n||_("invalid method name "+n+" for windmill.$callAsync."),new Promise(function(e,t){o.bridge.dispatchMessage({type:"ModuleCall",origin:a.origin||o.label,target:a.target||"AppWorker",data:{method:n,params:i,context:r}},e,t,!1)})},e.prototype.$call=function(e,t,n,i,r,a){return void 0===t&&(t={}),void 0===n&&(n=I),void 0===i&&(i=I),void 0===r&&(r={}),void 0===a&&(a={}),y('$call "'+e+'", params: '+JSON.stringify(t)),e||_("invalid method name "+e+" for windmill.$call."),this.bridge.dispatchMessage({type:"ModuleCall",origin:a.origin||this.label,target:a.target||"AppWorker",data:{method:e,params:t,context:r}},n,i,!0)},e.prototype.$registerModules=function(e){!function(t,r){if(void 0===r&&(r=!1),E(t)){var e=function(n){var e=t[n];A[n]?r||m('The "'+n+'" module has already been registered.It would be overridden.'):A[n]=[];var i=A[n];Array.isArray(e)?e.forEach(function(e){if(E(e))i.push(e);else if("string"==typeof e){var t=e;-1===i.indexOf(t)?i.push(t):r||m('The "'+t+'" of the "'+n+'" module has already been registered.')}}):b('Invalid parameter type! The method list of the "'+n+'" module should be an Array.')};for(var n in t)e(n)}else b("Invalid parameter type! The module definition is not a plain object.")}(e,!0)},e.prototype.$getAvailableModules=function(){return function(e){var t={};try{t=JSON.parse(JSON.stringify(e))}catch(e){}return t}(A)};var O="[[EVENT_MAP]]";function $(e,t){var n=e[O];return Array.isArray(n[t])||(n[t]=[]),n[t]}var R=function(){y("Create new EventEmitter."),Object.defineProperty(this,O,{configurable:!1,enumerable:!1,writable:!1,value:{}})};R.prototype.on=function(e,t){return y('EventEmitter: on("'+e+'")'),$(this,e).push({listener:t,once:!1,callCount:0}),this},R.prototype.once=function(e,t){return y('EventEmitter: once("'+e+'")'),$(this,e).push({listener:t,once:!0,callCount:0}),this},R.prototype.off=function(e,t){y('EventEmitter: off("'+e+'"'+(t?", listener":"")+")");var n=this[O];if(t){var i=n[e];if(Array.isArray(i)){var r=i.findIndex(function(e){return e.listener===t});-1!==r&&i.splice(r,1)}}else delete n[e];return this},R.prototype.emit=function(i){for(var e=[],t=arguments.length-1;0<t--;)e[t]=arguments[t+1];y('EventEmitter: emit("'+i+'", '+JSON.stringify(e)+")");var n=this[O],r=n[i];return Array.isArray(r)&&(n[i]=r.filter(function(t){try{t.listener.apply(null,e),t.callCount+=1}catch(e){throw b('Failed to emit the "'+i+'" event: '+e.toString()+"\nSource code: "+("function"==typeof(n=t.listener)?Function.prototype.toString.call(n):"")),e}var n;return!t.once})),this};var T=function(e){var i=this;this._env=k(),y("Create a new WorkerBridge. ("+JSON.stringify(this._env)+")"),this._origin=e.origin,this._emitter=new R,w(l,function(e,t,n){y("Receive message from container. (clientId: "+e+", data: "+JSON.stringify(t)+")"),i._handleMessageFromContainer(e,t,n)}),w("onmessage",function(e,t){y("Receive message from renderer. (message: "+JSON.stringify(e)+")"),i._handleMessageFromRenderer(e,t)})};T.prototype.getEmitter=function(){return this._emitter},T.prototype.dispatchMessage=function(e,t,n,i){e.target="Container",y("Dispatch message to container. (message: "+JSON.stringify(e)+")");var r=S();if("function"!=typeof r[u]){var a="Can't find the \""+u+'" API on the current context.';return b(a),n({status:"JS_ERROR",error:a})}var o,c=e.origin,s=e.data,l=e.callbackId,d=function(e){return e.status&&"SUCCESS"===e.status?t(e):n(e)};if("iOS"!==(o=this._env).platform||o.remoteDebug)r[u](c,s,this._genCallbackId(d,{origin:c,keepAlive:i,callbackId:l}),e.target);else try{r[u](c,s,d,e.target)}catch(e){var p=e&&(e.message||e.toString())||"call "+u+" failed.";b(p),n({status:"JS_ERROR",error:p})}},T.prototype.dispatchMessageSync=function(e){y("Dispatch message to container synchronously.");var t=S()[n];if("function"==typeof t)return t(e.origin,e.data);b("Can't find the \""+n+'" API on the current context.')},T.prototype._genCallbackId=function(e,t){var n=t.origin,i=t.keepAlive,r=t.callbackId,a=r||s();return this._emitter[i?"on":"once"]("callback@"+n+":"+a,e),a},T.prototype.onReceiveMessage=function(e,t){var n=e.type,i=e.data;void 0===i&&(i={});var r=i.once?"once":"on";this._emitter[r](n+"."+i.type,t)},T.prototype.unbindEventListener=function(e,t){this._emitter.off(e,t)},T.prototype.emitEvent=function(e,t){void 0===t&&(t={}),this._emitter.emit("Event."+e,{type:e,data:t})},T.prototype.postMessage=function(e){y("Post message to renderer. (message: "+JSON.stringify(e)+")");var t=S();if("function"!=typeof t.postMessage)return _("global postMessage API doesn't exist!");t.postMessage(e,e.target)},T.prototype._handleMessageFromContainer=function(e,t,n){var i=t.action,r=t.callbackId,a=t.result;switch(i){case"CALLBACK":this._emitter.emit("callback@"+e+":"+r,a);break;case"LIFECYCLE":var o=a.lifecycle,c=o.match(/^page:(\S+)$/);"AppWorker"!==e&&(c&&c[1]?o="page@"+e+":"+c[1]:o.match(/^page@/)&&_("invalid lifecycle name in "+l+": "+o+". Shouldn't include '@clientId' in it."),this.postMessage({type:"Lifecycle",origin:this._origin||n,target:e,data:a}),this._emitter.emit("Event."+d,{lifecycle:a.lifecycle,clientId:e})),this._emitter.emit("Lifecycle."+o,a.options);break;case"EVENT":var s;s="Global"===e?"Event@Global."+a.type:"Event."+a.type,this._emitter.emit(s,a);break;default:_("invalid action type in "+l+": "+i)}},T.prototype._handleMessageFromRenderer=function(t,e){var n=this,i=t.type,r=t.data,a=t.callbackId,o=t.keepAlive,c=t.origin||e;c&&"AppWorker"!==c||_('Received a message from renderer with invalid "origin": '+c+". Should be a clientId.");var s=function(e){n.postMessage({origin:n._origin,target:c,type:"Callback",callbackId:a,data:e})};switch(i){case"ModuleCall":this.dispatchMessage(t,function(e){s(e)},function(e){b("Call native module failed! "+JSON.stringify(t.data)),b(JSON.stringify(e)),s(e)},o);break;case"Event":this._emitter.emit(i+"."+r.type,Object.assign({origin:c},r));break;default:_("unexpected message type posted from renderer: "+i+".")}};var L,P=function(e){function t(){e.call(this),y("Create a new WorkerRuntime."),this._activeRenderers=[],this.label="AppWorker",this.bridge=new T({origin:this.label}),this._init()}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype._init=function(){var i=this;this.bridge.onReceiveMessage({origin:this.label,type:"Event",data:{type:"registerModules"}},function(t){t&&"registerModules"===t.type&&(y("Register available modules: ("+JSON.stringify(t.data)+")"),i.$registerModules(t.data),i._activeRenderers.forEach(function(e){i.bridge.postMessage({origin:i.label,target:e.label,type:"Event",data:t})}))}),this.bridge.onReceiveMessage({origin:this.label,type:"Event",data:{type:"[[RendererRuntimeReady]]"}},function(e){e&&E(e.data)&&(y("Receive renderer ready message. ("+JSON.stringify(e.data)+")"),i._activeRenderers.push(e.data),e.data.handshake&&i.bridge.postMessage({origin:i.label,target:e.data.label,type:"Event",data:{type:"registerModules",data:i.$getAvailableModules()}}))}),this.$on(d,function(n){n&&"page:show"===n.lifecycle&&(i._currentActivePageId=n.clientId,i.$once(d,function(e){var t=e&&e.clientId||"";"page:hide"===(e&&e.lifecycle||"")&&t&&t===n.clientId&&i._currentActivePageId===t&&(i._currentActivePageId="")}))})},t.prototype.ready=function(){this.bridge.dispatchMessage({origin:"AppWorker",type:"ModuleCall",data:{method:"AppWorker.runtimeReady"}},function(){y('Dispatched "AppWorker.runtimeReady" event success.')},function(){b('Failed to dispatch "AppWorker.runtimeReady" event.')})},t.prototype.$callSync=function(e,t){void 0===t&&(t={}),y('$callSync "'+e+'", params: '+JSON.stringify(t));var n=this.bridge.dispatchMessageSync({origin:this.label,type:"ModuleCall",data:{method:e,params:t}});return n&&"CALLBACK"===n.action?n.result:n},t.prototype.getEmitter=function(){return this.bridge.getEmitter()},t.prototype.$getCurrentActivePageId=function(){return this._currentActivePageId},t}(e),x=["$on","$once","$off","$emit","$cycle","$decycle","$call","$callSync","$callAsync","$navTo","$getAvailableModules","$getCurrentActivePageId"];function B(a){y("Setup worker framework. ("+JSON.stringify(a)+")");var e=a.name||"<-unknown DSL->",t=k();t&&(t.frameworkType=e,t.frameworkVersion="0.5.4",function(e){if(!e||!e.platform)return console.error("set logger environment failed.");Object.assign(v,e)}(t));var i,r,o,n,c,s,l=S()[f],d=(i=l,r={},x.forEach(function(n){"function"==typeof i[n]&&(r[n]=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return i[n].apply(i,e)})}),r);return y("Prepare runtime APIs: "+JSON.stringify(x)),w(h,(o=function(){return d},c=n||function(){for(var e,t=[],n=arguments.length;n--;)t[n]=arguments[n];return(e=o()).$call.apply(e,t)},s=n||function(){for(var e,t=[],n=arguments.length;n--;)t[n]=arguments[n];return(e=o()).$callSync.apply(e,t)},function(r){if(!r)return y("Require a universal module proxy."),{call:c};var e=A[r];if(Array.isArray(e)){y('Require the "'+r+'" module.');var t={};return e.forEach(function(n){if("string"==typeof n)t[n]=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return c.apply(void 0,[r+"."+n].concat(e))};else if(E(n)&&n.name){var i=n.name;n.sync?t[i]=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return s.apply(void 0,[r+"."+i].concat(e))}:t[i]=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return c.apply(void 0,[r+"."+i].concat(e))}}}),t}m('Require unknown module "'+r+"\".It may not exist or haven't been registered.")})),w(p,function(){return M(l,a)}),w(g,function(e){return t=l,i=e,r={},"function"==typeof(n=a).getPluginContext&&Object.assign(r,n.getPluginContext(i)),y("Get plugin context (name: "+n.name+", params: "+JSON.stringify(i)+"). "+Object.keys(r)),t.$call("AppWorker.pluginContextReady",{type:n.name,version:"0.5.4",apis:Object.keys(r)}),r;var t,n,i,r}),d.$call("AppWorker.ready",{type:e,version:"0.5.4"},function(){y('Dispatched "AppWorker.ready" event in '+e+" DSL success.")},function(){b('Failed to dispatch "AppWorker.ready" event.')}),d}return L=new P,w(f,L),w("__REGISTER_DSL_FRAMEWORK_IN_WORKER__",B),L.ready(),B});